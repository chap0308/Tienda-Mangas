const buscadorInput=document.querySelector("#inputSearch");box_search=document.getElementById("box-search"),bars_search=document.getElementById("ctn-bars-search"),cover_ctn_search=document.getElementById("cover-ctn-search"),inputSearch=document.getElementById("inputSearch"),box_search=document.getElementById("box-search");const carrito=document.querySelector("#carrito"),carrito1=document.querySelector("#carrito1"),irboton=document.querySelector(".ir"),inputDetalles=document.querySelector("#irDetalles"),listaProductos=document.querySelector("#lista-productos"),listaCompra=document.querySelector("#lista-compra"),contenedorCompra=document.querySelector("#lista-compra tbody"),contenedorCarrito=document.querySelector("#lista-carrito tbody"),listaCa=document.querySelector("#lista-carrito"),vaciarCarritoBtn=document.querySelector("#vaciar-carrito"),imagenCarrito=document.querySelector("#img-carrito"),Xcerrar=document.querySelector(".borrar-carrito"),mens=document.querySelector("#mensaje-carrito"),divSub=document.querySelector(".subtotal"),totalCompra=document.querySelector("#totalCompra"),mensCompra=document.querySelector("#mensaje-compra"),procesarCompra=document.querySelector("#procesar-compra"),actualizarpago=document.querySelector("#actualizar-pago"),mostrarCont=document.querySelector("#mostrar-contenido"),spinnerC=document.querySelector("#spiner"),listaDetalles=document.querySelector(".contenedor-app"),usuario=document.querySelector("#idUsuario");let articulosCarrito=[],cantDeta=1;function iniciarApp(){consultarAPI(),CargarlocalStorage(),actualizarpago&&(Spinner(),actualizarInventario())}async function consultarAPI(){try{
//! const url =`${location.origin}/api/productos`;
const t="/api/productos",e=await fetch(t);mostrarProductos((await e.json()).productos)}catch(t){console.log(t)}}function cargarEventListeners(){null!=listaProductos&&listaProductos.addEventListener("click",agregarCurso),null!=listaDetalles&&(listaDetalles.addEventListener("click",agregarManga),listaDetalles.addEventListener("click",eliminarManga)),carrito.addEventListener("click",eliminarCurso),null!=carrito1&&carrito1.addEventListener("click",eliminarCurso),vaciarCarritoBtn.addEventListener("click",()=>{articulosCarrito=[],localStorage.removeItem("carrito"),limpiarHtml(contenedorCarrito),limpiarHtml(divSub),mens.style.display="block",vaciarCarritoBtn.style.display="none",irboton.style.display="none",listaCa.style.display="none"}),imagenCarrito.addEventListener("click",(function(){clickCarrito("ventana")})),Xcerrar.addEventListener("click",(function(){clickCarrito("ventana")})),irboton.addEventListener("click",(function(){window.location="/carrito"})),null!=procesarCompra&&procesarCompra.addEventListener("click",realizarCompra)}function CargarlocalStorage(){articulosCarrito=JSON.parse(localStorage.getItem("carrito"))||[],token=JSON.parse(localStorage.getItem("token"))||"",carritoHTML(),null!==contenedorCompra&&compraHTML(),0===articulosCarrito.length?(vaciarCarritoBtn.style.display="none",listaCa.style.display="none",null!=contenedorCompra&&(listaCompra.style.display="none",mensCompra.style.display="block",procesarCompra.style.display="none")):(vaciarCarritoBtn.style.display="block",listaCa.style.display="block",mens.style.display="none")}function agregarManga(t){if(t.preventDefault(),t.target.classList.contains("agregar-carrito")){vaciarCarritoBtn.style.display="block",listaCa.style.display="block",mens.style.display="none",irboton.style.display="block";const e=t.target.parentElement.parentElement.parentElement;return cantStr=document.querySelector("#cantidadDe").textContent,cantDeta=parseInt(cantStr),leerDatosCurso(e,"manga")}}function eliminarManga(t){t.preventDefault(),t.target.classList.contains("btn-info")&&(cantDeta++,document.querySelector("#cantidadDe").textContent=cantDeta),t.target.classList.contains("btn-danger")&&cantDeta>1&&(cantDeta--,document.querySelector("#cantidadDe").textContent=cantDeta)}function agregarCurso(t){if(t.preventDefault(),t.target.classList.contains("agregar-carrito")){vaciarCarritoBtn.style.display="block",listaCa.style.display="block",mens.style.display="none",irboton.style.display="block";return leerDatosCurso(t.target.parentElement,"curso")}const e=t.target.parentElement.dataset.manga;if(e)return irDetalles(e)}function irDetalles(t){window.location="/detalles?id="+t}function leerDatosCurso(t,e){const a={imagen:t.querySelector("img").src,titulo:t.querySelector("span").textContent,precio:t.querySelector(".precioC span").textContent,id:t.querySelector("button").getAttribute("data-id"),cantidad:"curso"===e?1:cantDeta,stock:t.querySelector(".stock span").textContent};if(console.log(a),articulosCarrito.some(t=>t.id===a.id)){const t=articulosCarrito.map(t=>t.id===a.id?(t.cantidad+=a.cantidad,t):t);articulosCarrito=[...t],clickCarrito("producto"),console.log(articulosCarrito)}else articulosCarrito=[a,...articulosCarrito],clickCarrito("producto");carritoHTML()}function eliminarCurso(t){if(t.preventDefault(),t.target.classList.contains("borrar-curso")){const e=t.target.parentElement.querySelector("a").getAttribute("data-id");articulosCarrito=articulosCarrito.filter(t=>t.id!==e),carritoHTML(),null!=contenedorCompra&&compraHTML(),0===articulosCarrito.length&&(mens.style.display="block",vaciarCarritoBtn.style.display="none",irboton.style.display="none",listaCa.style.display="none",null!=contenedorCompra&&(listaCompra.style.display="none",mensCompra.style.display="block",procesarCompra.style.display="none"))}if(t.target.classList.contains("btn-info")){const e=t.target.parentElement.querySelector("button").getAttribute("data-id"),a=articulosCarrito.map(t=>{if(t.id===e){let e=parseInt(t.cantidad);return e++,t.cantidad=e,t}return t});articulosCarrito=[...a],carritoHTML(),null!=contenedorCompra&&compraHTML()}if(t.target.classList.contains("btn-danger")){const e=t.target.parentElement.querySelector("button").getAttribute("data-id"),a=articulosCarrito.map(t=>{if(t.id===e){let e=parseInt(t.cantidad);return e--,t.cantidad=e,t}return t});articulosCarrito=a.filter(t=>0!==t.cantidad),carritoHTML(),null!=contenedorCompra&&compraHTML(),0===articulosCarrito.length&&(mens.style.display="block",vaciarCarritoBtn.style.display="none",irboton.style.display="none",listaCa.style.display="none",null!=contenedorCompra&&(listaCompra.style.display="none",mensCompra.style.display="block",procesarCompra.style.display="none"))}}function carritoHTML(){limpiarHtml(contenedorCarrito),articulosCarrito.forEach(t=>{const e=document.createElement("tr");e.setAttribute("style","border-bottom: 1px solid #E1E1E1;"),e.innerHTML=`\n            <td>  \n                <img src="${t.imagen}" width=100>\n            </td>\n            <td>${t.titulo}</td>\n            <td class="price">S/. ${t.precio}</td>\n            <td >\n            <button class="btn btn-info btn-sm" style="padding-left: 1rem;" data-id="${t.id}">\n                +\n            </button>\n            <p class="cant">${t.cantidad}</p>\n            <button class="btn btn-danger btn-sm" style="padding-left: 1.3rem;" data-id="${t.id}">\n            -\n            </button>\n            </td>\n            \n            <td>\n                <a href="#" class="borrar-curso" data-id="${t.id}">X</a>\n            </td>\n            \n        `,contenedorCarrito.appendChild(e)});let t=calcularTotalCarrito();if(t>0){limpiarHtml(divSub),limpiarHtml(irboton);const e=document.createElement("span");e.textContent="Subtotal del carrito: ";const a=document.createElement("span");a.classList.add("price"),a.textContent=`S/. ${t} `;const r=document.createElement("a");r.href="/carrito",r.id="ir-carrito",r.className="boton",r.textContent="Ver y editar carrito",divSub.appendChild(e),divSub.appendChild(a),irboton.appendChild(r)}else limpiarHtml(divSub);sincronizarStorage()}function compraHTML(){limpiarHtml(contenedorCompra),articulosCarrito.forEach(t=>{const e=document.createElement("tr");e.setAttribute("style","border-bottom: 1px solid #E1E1E1;"),e.innerHTML=`\n            <td>  \n                <img src="${t.imagen}" width=100>\n            </td>\n            <td>${t.titulo}</td>\n            <td class="price">S/. ${t.precio}</td>\n            <td >\n            <button class="btn btn-info btn-sm" style="padding-left: 1rem;" data-id="${t.id}">\n                +\n            </button>\n            <p class="cant">${t.cantidad}</p>\n            <button class="btn btn-danger btn-sm" style="padding-left: 1.3rem;" data-id="${t.id}">\n            -\n            </button>\n            </td>\n            <td>\n                <p class="price">S/. ${t.cantidad*t.precio}</p>\n            </td>\n            <td>\n                <a href="#" class="borrar-curso" data-id="${t.id}">X</a>\n            </td>\n            \n        `,contenedorCompra.appendChild(e)})}function sincronizarStorage(){localStorage.setItem("carrito",JSON.stringify(articulosCarrito))}function calcularTotalCarrito(){const t=articulosCarrito.reduce((t,{cantidad:e,precio:a})=>t+e*a,0);return null!=totalCompra&&(totalCompra.textContent="S/. "+t),t}async function realizarCompra(t){t.preventDefault();calcularTotalCarrito();const e=usuario.textContent;if(""===e)return void(window.location.href="/login");const a=articulosCarrito.map(t=>t.titulo),r=articulosCarrito.map(t=>t.precio),o=articulosCarrito.map(t=>t.cantidad),n=new FormData;n.append("idUsuario",e),n.append("nombre",a),n.append("cantidad",o),n.append("precio_unitario",r);try{
//! const url =`${location.origin}/carrito`;
const t="/carrito",e=await fetch(t,{method:"POST",body:n}),a=await e.json();a&&(window.location.href=a.session.url)}catch(t){Swal.fire({icon:"error",title:"Error",text:"Hubo un error al realizar la compra"})}}async function actualizarInventario(){const t=calcularTotalCarrito(),e=articulosCarrito.map(t=>t.id),a=articulosCarrito.map(t=>t.precio),r=articulosCarrito.map(t=>t.cantidad),o=document.querySelector("#fecha").textContent,n=articulosCarrito.map(t=>parseInt(t.stock)),i=usuario.textContent,c=n.map((t,e)=>t-r[e]),l=articulosCarrito.map((t,e)=>t.precio*r[e]),s=window.location.search,d=(new URLSearchParams(s).get("token"),new FormData);d.append("idUsuario",i),d.append("total",t),d.append("fecha_compra",o),d.append("productos",e),d.append("precio_unitario",a),d.append("cantidad",r),d.append("precio_venta",l),d.append("stock",c);try{
//! const url =`${location.origin}/api/compras`;
const t="/api/compras",e=await fetch(t,{method:"POST",body:d});await e.json()&&(localStorage.removeItem("carrito"),CargarlocalStorage(),irboton.style.display="none",mens.style.display="block",spinnerC.style.display="none",mostrarCont.style.display="block",Swal.fire({icon:"success",title:"Compra Realizada",text:"La compra fue realizada correctamente",button:"OK"}))}catch(t){Swal.fire({icon:"error",title:"Error",text:"Hubo un error al realizar la compra"})}}function limpiarHtml(t){for(;t.firstChild;)t.removeChild(t.firstChild)}function clickCarrito(t){let e=window.getComputedStyle(carrito);"ventana"==t?"none"===e.display?carrito.style.display="block":carrito.style.display="none":"producto"==t&&(e.display,carrito.style.display="block")}function mostrar_buscador(){bars_search.style.top="80px",cover_ctn_search.style.display="block",inputSearch.focus(),""===inputSearch.value&&(box_search.style.display="none")}function ocultar_buscador(){bars_search.style.top="-10px",cover_ctn_search.style.display="none",inputSearch.value="",box_search.style.display="none"}function mostrarProductos(t=[]){t.forEach(t=>{const e=document.createElement("li"),a=document.createElement("a");a.href="/detalles?id="+t.id;const r=document.createElement("i");r.className="fas fa-search",a.appendChild(r),a.textContent=t.Titulo,e.appendChild(a),box_search.appendChild(e)}),document.getElementById("inputSearch").addEventListener("keyup",(function(){for(filter=inputSearch.value.toUpperCase(),li=box_search.getElementsByTagName("li"),i=0;i<li.length;i++)a=li[i].getElementsByTagName("a")[0],textValue=a.textContent||a.innerText,textValue.toUpperCase().indexOf(filter)>-1?(li[i].style.display="",box_search.style.display="block",""===inputSearch.value&&(box_search.style.display="none")):li[i].style.display="none"}))}function Spinner(){const t=document.createElement("div");t.classList.add("sk-circle"),t.innerHTML='\n        <div class="sk-circle1 sk-child"></div>\n        <div class="sk-circle2 sk-child"></div>\n        <div class="sk-circle3 sk-child"></div>\n        <div class="sk-circle4 sk-child"></div>\n        <div class="sk-circle5 sk-child"></div>\n        <div class="sk-circle6 sk-child"></div>\n        <div class="sk-circle7 sk-child"></div>\n        <div class="sk-circle8 sk-child"></div>\n        <div class="sk-circle9 sk-child"></div>\n        <div class="sk-circle10 sk-child"></div>\n        <div class="sk-circle11 sk-child"></div>\n        <div class="sk-circle12 sk-child"></div>\n    ',spinnerC.appendChild(t)}document.addEventListener("DOMContentLoaded",(function(){iniciarApp()})),cargarEventListeners(),document.getElementById("icon-search").addEventListener("click",mostrar_buscador),document.getElementById("cover-ctn-search").addEventListener("click",ocultar_buscador);